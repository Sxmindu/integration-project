<?xml version="1.0" encoding="UTF-8"?>
<sequence name="GetBooksSeq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">
    <filter xpath="string-length(get-property('query.param.skip')) > 0 or string-length(get-property('query.param.fetch')) > 0">
        <then>
            <dataServiceCall serviceName="BookDataService">
                <operations type="single">
                    <operation name="getPaginationBooks">
                        <param name="skip" expression="get-property('query.param.skip')"/>
                        <param name="fetch" expression="get-property('query.param.fetch')"/>
                    </operation>
                </operations>
                <source type="inline"/>
                <target type="body"/>
            </dataServiceCall>
            <log category="INFO">
                <message>Result: ${payload}</message>
            </log>
            <filter xpath="${exists($.Data)}">
                <then>
                    <payloadFactory media-type="json">
                        <format>
                            ${payload.Data}
                        </format>
                    </payloadFactory>
                </then>
                <else>
                    <filter xpath="string(get-property('query.param.fetch')) = '0'">
                        <then>
                            <payloadFactory media-type="json">
                                <format>
                                    {
                                    "message": "Query param fetch should be greater than 0"
                                    }
                                </format>
                            </payloadFactory>
                        </then>
                        <else>
                            <payloadFactory media-type="json">
                                <format>
                                    {
                                    "message": "No books found"
                                    }
                                </format>
                            </payloadFactory>
                        </else>
                    </filter>
                </else>
            </filter>
        </then>
        <else>
            <dataServiceCall serviceName="BookDataService">
                <operations type="single">
                    <operation name="getBooks"/>
                </operations>
                <source type="inline"/>
                <target type="body"/>
            </dataServiceCall>
            <log category="DEBUG">
                <message>Result: ${payload.Data}</message>
            </log>
            <filter xpath="${exists($.Data)}">
                <then>
                    <payloadFactory media-type="json">
                        <format>
                            ${payload.Data}
                        </format>
                    </payloadFactory>
                </then>
                <else>
                    <payloadFactory media-type="json">
                        <format>
                            {
                            "message": "No books found"
                            }
                        </format>
                    </payloadFactory>
                </else>
            </filter>
        </else>
    </filter>
    <respond/>
</sequence>